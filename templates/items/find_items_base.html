{% extends 'base_template.html' %}
{% load static %}

{% block title %}{% block find_title %}æ‰¾ç‰©å“ - iStorage{% endblock %}{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/custom.css' %}">
    {% block find_extra_css %}{% endblock %}
{% endblock %}

{% block content %}
<!-- æ¨èæ•°æ® - ä½¿ç”¨json_scriptå­˜å‚¨ -->
{{ recommended_rooms|json_script:"recommended-rooms" }}
{{ recommended_categories|json_script:"recommended-categories" }}

<div class="find-layout">
    <!-- ä¾§è¾¹æ  -->
    <!-- ä½¿ç”¨ç»Ÿä¸€çš„ä¾§è¾¹æ æ¨¡æ¿ç‰‡æ®µ -->
    {% include 'items/sidebar.html' %}
    
    <!-- ä¸»å†…å®¹åŒº -->
    <main class="main-content">
        <!-- é¡¶éƒ¨åŒºåŸŸï¼šç»Ÿè®¡å¡ç‰‡å’Œæœç´¢åŒº -->
        <div class="top-section">
            <!-- é¡¶éƒ¨ç»Ÿè®¡å¡ç‰‡ -->
            <div class="stats-section">
                <div class="stat-card">
                    <div class="stat-label">ç‰©å“æ€»æ•°</div>
                    <div class="stat-number" id="total-items-number">{{ total_items }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label" id="first-stat-label">
                        {% if filter_type == 'room' %}æˆ¿é—´æ•°{% else %}åˆ†ç±»æ•°{% endif %}
                    </div>
                    <div class="stat-number" id="first-stat-number">
                        {% if filter_type == 'room' %}{{ room_count }}{% else %}{{ category_count }}{% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ ‡é¢˜åŒºåŸŸ -->
        <div class="section-header">
            <h3 class="section-title">{% block section_title %}{% if search_query %}æœç´¢ç»“æœ{% else %}ç‰©å“åˆ—è¡¨{% endif %}{% endblock %}</h3>
        </div>
        
        <!-- æ•°æ®å±•ç¤ºåŒºåŸŸ -->
        <div class="items-section">
            {% block items_content %}
            {% if items %}
                {% for group_name, group_items in grouped_items.items %}
                    <div class="items-group">
                        <div class="group-header">
                            <a href="#" class="group-title-link" data-group="{{ group_name|slugify }}">{{ group_name }}</a>
                            <span class="group-count">{{ group_items|length }}ä»¶</span>
                        </div>
                        <div class="items-grid" id="grid-{{ group_name|slugify }}">
                            {% for item in group_items %}
                                <div class="item-card" data-item-id="{{ item.id }}" data-item-name="{{ item.name|escapejs }}" data-room="{{ item.location|slugify }}" data-category="{{ item.category.name|default:'æœªåˆ†ç±»'|slugify }}">
                                    <div class="item-card-header">
                                        <h4 class="item-name">{{ item.name|default:"æœªå‘½åç‰©å“" }}</h4>
                                    </div>
                                    <div class="item-card-content">
                                        <div class="item-meta">
                                            <div class="meta-item">
                                                <span class="meta-label">æˆ¿é—´:</span>
                                                <span class="meta-value">{{ item.location|default:"æœªæŒ‡å®š" }}</span>
                                            </div>
                                            <div class="meta-item">
                                                <span class="meta-label">åˆ†ç±»:</span>
                                                <span class="meta-value">{{ item.category|default:"â€”" }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <div class="empty-icon">
                        {% if search_query %}
                            ğŸ”
                        {% else %}
                            ğŸ“¦
                        {% endif %}
                    </div>
                    <p class="empty-text">
                        {% if search_query %}
                            æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ç‰©å“
                        {% else %}
                            æš‚æ— å­˜æ”¾è®°å½•
                        {% endif %}
                    </p>
                </div>
            {% endif %}
            {% endblock %}
        </div>
    </main>
</div>

<!-- æ·»åŠ åˆ†ç±»/æˆ¿é—´æ¨¡æ€æ¡† -->
<div class="modal" id="add-modal" style="display: none;">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="modal-title">æ·»åŠ æˆ¿é—´</h3>
            <button class="modal-close" id="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <form id="add-form">
                <input type="hidden" id="modal-type" name="type" value="room">
                <div class="form-group">
                    <label for="modal-name" class="form-label">åç§°</label>
                    <input type="text" id="modal-name" name="name" class="form-input" placeholder="è¯·è¾“å…¥åç§°" required>
                </div>
                <!-- æ¨èåˆ—è¡¨ -->
                <div class="recommendations">
                    <h4 class="recommendations-title">æ¨è</h4>
                    <div class="recommendations-list" id="recommendations-list">
                        <!-- æ¨èå†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel-btn" id="modal-cancel">å–æ¶ˆ</button>
            <button class="modal-btn confirm-btn" id="modal-confirm">æ·»åŠ </button>
        </div>
    </div>
</div>

<!-- å¯¼èˆªæ¨¡æ€æ¡† - ç”¨äºæ–°å»ºå­æ ‡ç­¾ -->
<div class="modal" id="nav-modal" style="display: none;">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">æ–°å»ºå­æ ‡ç­¾</h3>
            <button class="modal-close" id="nav-modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <form id="nav-form">
                <input type="hidden" name="action" value="add">
                <input type="hidden" name="parent_id" value="">
                <div class="form-group">
                    <label for="nav-name" class="form-label">åç§°</label>
                    <input type="text" id="nav-name" name="name" class="form-input" placeholder="è¯·è¾“å…¥å­æ ‡ç­¾åç§°" required>
                </div>
                <div class="form-group">
                    <label for="nav-icon" class="form-label">å›¾æ ‡</label>
                    <input type="text" id="nav-icon" name="icon" class="form-input" placeholder="è¯·è¾“å…¥å›¾æ ‡ï¼ˆå¦‚ğŸ“¦ï¼‰" required>
                </div>
                <div class="form-group">
                    <label for="nav-url" class="form-label">URL</label>
                    <input type="text" id="nav-url" name="url" class="form-input" placeholder="è¯·è¾“å…¥URLè·¯å¾„ï¼ˆå¦‚/items/find/ï¼‰" required>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel-btn" id="nav-modal-cancel">å–æ¶ˆ</button>
            <button class="modal-btn confirm-btn" id="nav-modal-save" type="submit" form="nav-form">ä¿å­˜</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    // æ¨èæ•°æ®
    const recommendedRooms = JSON.parse(document.getElementById('recommended-rooms').textContent);
    const recommendedCategories = JSON.parse(document.getElementById('recommended-categories').textContent);
    
    const recommendedData = {
        rooms: recommendedRooms,
        categories: recommendedCategories
    };

    // Helper functions
    function getCookie(name) {
        const match = document.cookie.match(`(^|;) ?${name}=([^;]*)(;|$)`);
        return match ? decodeURIComponent(match[2]) : null;
    }

    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    function showModal(type) {
        const modal = document.getElementById('add-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalType = document.getElementById('modal-type');
        const recommendationsList = document.getElementById('recommendations-list');
        const modalName = document.getElementById('modal-name');
        
        // è®¾ç½®æ¨¡æ€æ¡†æ ‡é¢˜å’Œç±»å‹
        if (type === 'room') {
            modalTitle.textContent = 'æ·»åŠ æˆ¿é—´';
            modalType.value = 'room';
            // åŠ è½½æˆ¿é—´æ¨è
            renderRecommendations(recommendationsList, recommendedData.rooms);
        } else {
            modalTitle.textContent = 'æ·»åŠ åˆ†ç±»';
            modalType.value = 'category';
            // åŠ è½½åˆ†ç±»æ¨è
            renderRecommendations(recommendationsList, recommendedData.categories);
        }
        
        // æ¸…ç©ºè¾“å…¥æ¡†
        modalName.value = '';
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡† - æ”¹ä¸ºflexä»¥ä¿æŒå±…ä¸­
        modal.style.display = 'flex';
        
        // é˜»æ­¢èƒŒæ™¯æ»šåŠ¨
        document.body.style.overflow = 'hidden';
    }

    // éšè—æ¨¡æ€æ¡†
    function hideModal() {
        const modal = document.getElementById('add-modal');
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    // æ¸²æŸ“æ¨èåˆ—è¡¨
    function renderRecommendations(container, recommendations) {
        container.innerHTML = '';
        if (recommendations.length === 0) {
            container.innerHTML = '<div class="no-recommendations">æš‚æ— æ¨è</div>';
            return;
        }
        
        recommendations.forEach(item => {
            const recommendationItem = document.createElement('div');
            recommendationItem.className = 'recommendation-item';
            recommendationItem.dataset.value = item;
            recommendationItem.textContent = item;
            recommendationItem.addEventListener('click', () => {
                document.getElementById('modal-name').value = item;
            });
            container.appendChild(recommendationItem);
        });
    }

    // æäº¤æ·»åŠ è¡¨å•
    function submitAddForm() {
        const form = document.getElementById('add-form');
        const type = document.getElementById('modal-type').value;
        const name = document.getElementById('modal-name').value.trim();
        
        if (!name) {
            alert('è¯·è¾“å…¥åç§°');
            return;
        }
        
        // å‘é€è¯·æ±‚
        const url = type === 'room' ? "{% url 'items:add_room' %}" : "{% url 'items:add_category' %}";
        fetch(url, {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: new URLSearchParams({
                name: name
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // åˆ·æ–°é¡µé¢
                window.location.reload();
            } else {
                alert('æ·»åŠ å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
        })
        .catch(error => {
            console.error('æ·»åŠ å¤±è´¥:', error);
            alert('æ·»åŠ å¤±è´¥: ç½‘ç»œé”™è¯¯');
        });
    }

    // Modal handling for items
    function showItemModal(html, itemId) {
        let container = document.getElementById('modal-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'modal-container';
            document.body.appendChild(container);
        }
        container.innerHTML = html;
        
        // å­˜å‚¨ç‰©å“IDåˆ°å®¹å™¨ä¸­ï¼Œæ–¹ä¾¿åç»­ä½¿ç”¨
        container.dataset.itemId = itemId;
        
        // ç»‘å®šæ¨¡æ€æ¡†å…³é—­äº‹ä»¶
        bindItemModalEvents(container);
        
        // é˜»æ­¢èƒŒæ™¯æ»šåŠ¨
        document.body.style.overflow = 'hidden';
    }

    function closeItemModal() {
        const container = document.getElementById('modal-container');
        if (container) container.innerHTML = '';
        document.body.style.overflow = 'auto';
    }

    function bindItemModalEvents(container) {
        // å…³é—­æŒ‰é’®äº‹ä»¶
        container.querySelectorAll('[data-close-modal]').forEach(el => {
            el.addEventListener('click', closeItemModal);
        });
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        container.addEventListener('click', (e) => {
            if (e.target === container) {
                closeItemModal();
            }
        });
        
        // ä¿å­˜æŒ‰é’®äº‹ä»¶
        const saveBtn = container.getElementById('save-item-btn');
        if (saveBtn) {
            saveBtn.addEventListener('click', () => {
                // ä»å®¹å™¨datasetä¸­è·å–ç‰©å“ID
                const itemId = container.dataset.itemId;
                saveItem(itemId);
            });
        }
        
        // åˆ é™¤æŒ‰é’®äº‹ä»¶
        const deleteBtn = container.getElementById('delete-item-btn');
        if (deleteBtn) {
            deleteBtn.addEventListener('click', () => {
                // ä»å®¹å™¨datasetä¸­è·å–ç‰©å“ID
                const itemId = container.dataset.itemId;
                deleteItem(itemId);
            });
        }
    }

    // ä¿å­˜ç‰©å“
    function saveItem(itemId) {
        const form = document.getElementById('item-form');
        const formData = new FormData(form);
        
        fetch(`{% url 'items:item_detail' 0 %}`.replace('/0/', `/${itemId}/`), {
            method: 'POST',
            credentials: 'same-origin',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // åˆ·æ–°é¡µé¢
                window.location.reload();
            } else {
                alert('ä¿å­˜å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
        })
        .catch(error => {
            console.error('ä¿å­˜å¤±è´¥:', error);
            alert('ä¿å­˜å¤±è´¥: ç½‘ç»œé”™è¯¯');
        });
    }

    // åˆ é™¤ç‰©å“
    function deleteItem(itemId) {
        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç‰©å“å—ï¼Ÿ')) {
            fetch(`{% url 'items:delete_item' 0 %}`.replace('/0/', `/${itemId}/`), {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // åˆ·æ–°é¡µé¢
                    window.location.reload();
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            })
            .catch(error => {
                console.error('åˆ é™¤å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥: ç½‘ç»œé”™è¯¯');
            });
        }
    }

    // Fetch modal content for an item
    function openItemModal(id) {
        fetch(`{% url 'items:item_detail' 0 %}`.replace('/0/', `/${id}/`) + '?modal=1', {
            credentials: 'same-origin'
        })
        .then(response => response.text())
        .then(html => {
            showItemModal(html, id);
        })
        .catch(error => {
            console.error('Failed to load modal:', error);
        });
    }

    // æ›´æ–°ç­›é€‰çŠ¶æ€
    function updateFilter(filterType) {
        // æ›´æ–°å¯¼èˆªæ¿€æ´»çŠ¶æ€
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
        document.querySelector(`[data-filter="${filterType}"]`).classList.add('active');
        
        // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
        const firstStatLabel = document.getElementById('first-stat-label');
        const firstStatNumber = document.getElementById('first-stat-number');
        
        if (filterType === 'room') {
            firstStatLabel.textContent = 'æˆ¿é—´æ•°';
            firstStatNumber.textContent = '{{ room_count }}';
        } else {
            firstStatLabel.textContent = 'åˆ†ç±»æ•°';
            firstStatNumber.textContent = '{{ category_count }}';
        }
    }

    // å¯¼èˆªæ¨¡æ€æ¡†åŠŸèƒ½
    // æ˜¾ç¤ºå¯¼èˆªæ¨¡æ€æ¡†
    function showNavModal() {
        const modal = document.getElementById('nav-modal');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }
    
    // éšè—å¯¼èˆªæ¨¡æ€æ¡†
    function hideNavModal() {
        const modal = document.getElementById('nav-modal');
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }
    
    // å¤„ç†å¯¼èˆªè¡¨å•æäº¤
    function handleNavFormSubmit(e) {
        e.preventDefault();
        
        const form = e.target;
        const formData = new FormData(form);
        
        fetch("{% url 'items:manage_navigation' %}", {
            method: 'POST',
            credentials: 'same-origin',
            body: formData
        }).then(response => response.json())
          .then(data => {
            if (data.success) {
                // éšè—æ¨¡æ€æ¡†
                hideNavModal();
                // åˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºæ–°æ·»åŠ çš„å­æ ‡ç­¾
                window.location.reload();
            } else {
                alert('æ·»åŠ å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
        }).catch(error => {
            console.error('æ·»åŠ å¤±è´¥:', error);
            alert('æ·»åŠ å¤±è´¥: ç½‘ç»œé”™è¯¯');
        });
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        // è·å–å½“å‰ç­›é€‰ç±»å‹
        const currentFilter = new URLSearchParams(window.location.search).get('filter') || 'room';
        
        // æ›´æ–°ç­›é€‰çŠ¶æ€
        updateFilter(currentFilter);
        
        // Card click handling
        document.querySelectorAll('[data-item-id]').forEach(card => {
            card.addEventListener('click', () => {
                const id = card.getAttribute('data-item-id');
                openItemModal(id);
            });
        });
        
        // å¯¼èˆªé“¾æ¥ç‚¹å‡»äº‹ä»¶ - ä¸ºæ‰€æœ‰å¯¼èˆªé¡¹æ·»åŠ ç›¸åŒçš„äº¤äº’æ•ˆæœ
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const filterType = item.getAttribute('data-filter');
                const link = item.querySelector('a');
                window.location.href = link.getAttribute('href');
            });
        });
    
        // æ·»åŠ æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('add-item-btn').addEventListener('click', (e) => {
            const type = e.target.closest('.add-btn').getAttribute('data-type');
            showModal(type);
        });
    
        // ç»‘å®šå¯¼èˆªæ¨¡æ€æ¡†äº‹ä»¶
        document.getElementById('nav-modal-close').addEventListener('click', hideNavModal);
        document.getElementById('nav-modal-cancel').addEventListener('click', hideNavModal);
    
        // è¡¨å•æäº¤äº‹ä»¶
        const navForm = document.getElementById('nav-form');
        if (navForm) {
            navForm.addEventListener('submit', handleNavFormSubmit);
        }
    
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('nav-modal').addEventListener('click', (e) => {
            if (e.target.id === 'nav-modal') {
                hideNavModal();
            }
        });
        
        // æ¨¡æ€æ¡†å…³é—­äº‹ä»¶
        document.getElementById('modal-close').addEventListener('click', hideModal);
        document.getElementById('modal-cancel').addEventListener('click', hideModal);
        
        // æ¨¡æ€æ¡†æäº¤äº‹ä»¶
        document.getElementById('modal-confirm').addEventListener('click', submitAddForm);
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('add-modal').addEventListener('click', (e) => {
            if (e.target.id === 'add-modal') {
                hideModal();
            }
        });
        
        // åˆ†ç±»æ ‡é¢˜ç‚¹å‡»å±•å¼€/æŠ˜å åŠŸèƒ½
        document.querySelectorAll('.group-title-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                
                const group = link.dataset.group;
                const grid = document.getElementById(`grid-${group}`);
                
                // åˆ‡æ¢æ˜¾ç¤º/éšè—çŠ¶æ€
                if (grid.style.display === 'none') {
                    grid.style.display = 'grid';
                    link.style.fontWeight = '600';
                } else {
                    grid.style.display = 'none';
                    link.style.fontWeight = '500';
                }
            });
        });
    });
})();
</script>
{% endblock %}
