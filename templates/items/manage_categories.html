{% extends 'items/find_items_base.html' %}
{% load static %}

{% block title %}ç®¡ç†åˆ†ç±» - iStorage{% endblock %}

{% block section_title %}åˆ†ç±»ç®¡ç†{% endblock %}

{% block items_content %}
<!-- åˆ†ç±»ç®¡ç†æ•°æ®å±•ç¤ºåŒºåŸŸ -->
<div class="items-section" id="content-categories">
    {% if categories %}
        <div class="items-grid">
            {% for category in categories %}
                <div class="item-card">
                    <div class="item-card-header">
                        <h4 class="item-name">{{ category.name }}</h4>
                    </div>
                    <div class="item-card-content">
                        <div class="item-meta">
                            <div class="meta-item">
                                <span class="meta-label">æ“ä½œ</span>
                                <span class="meta-value">
                                    <button class="action-btn edit-btn" onclick="showEditModal('category', '{{ category.id }}', '{{ category.name }}')" style="background: none; border: none; cursor: pointer; color: var(--accent); font-size: 14px;">
                                        âœï¸
                                    </button>
                                    <form method="post" action="{% url 'items:manage_categories' %}" style="display: inline;">
                                        {% csrf_token %}
                                        <input type="hidden" name="delete_category" value="1">
                                        <input type="hidden" name="category_id" value="{{ category.id }}">
                                        <button type="submit" class="action-btn delete-btn" onclick="return confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåˆ†ç±»å—ï¼Ÿ')" style="background: none; border: none; cursor: pointer; color: #ff3b30; font-size: 14px;">
                                            ğŸ—‘ï¸
                                        </button>
                                    </form>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-state">
            <div class="empty-icon">ğŸ“</div>
            <p class="empty-text">æš‚æ— åˆ†ç±»</p>
        </div>
    {% endif %}
</div>

<!-- æˆ¿é—´ç®¡ç†æ ‡é¢˜åŒºåŸŸ -->
<div class="section-header" style="margin-top: var(--spacing-xl);">
    <h3 class="section-title">æˆ¿é—´ç®¡ç†</h3>
</div>

<!-- æˆ¿é—´ç®¡ç†æ•°æ®å±•ç¤ºåŒºåŸŸ -->
<div class="items-section" id="content-rooms">
    {% if rooms %}
        <div class="items-grid">
            {% for room in rooms %}
                <div class="item-card">
                    <div class="item-card-header">
                        <h4 class="item-name">{{ room }}</h4>
                    </div>
                    <div class="item-card-content">
                        <div class="item-meta">
                            <div class="meta-item">
                                <span class="meta-label">æ“ä½œ</span>
                                <span class="meta-value">
                                    <button class="action-btn edit-btn" onclick="showEditModal('room', '', '{{ room }}')" style="background: none; border: none; cursor: pointer; color: var(--accent); font-size: 14px;">
                                        âœï¸
                                    </button>
                                    <form method="post" action="{% url 'items:manage_categories' %}" style="display: inline;">
                                        {% csrf_token %}
                                        <input type="hidden" name="delete_room" value="1">
                                        <input type="hidden" name="room_name" value="{{ room }}">
                                        <button type="submit" class="action-btn delete-btn" onclick="return confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæˆ¿é—´å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰ä½¿ç”¨è¯¥æˆ¿é—´çš„ç‰©å“çš„ä½ç½®ä¿¡æ¯ã€‚')" style="background: none; border: none; cursor: pointer; color: #ff3b30; font-size: 14px;">
                                            ğŸ—‘ï¸
                                        </button>
                                    </form>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-state">
            <div class="empty-icon">ğŸ </div>
            <p class="empty-text">æš‚æ— æˆ¿é—´</p>
        </div>
    {% endif %}
</div>

<!-- ç¼–è¾‘æ¨¡æ€æ¡† -->
<div class="modal" id="edit-modal" style="display: none;">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="edit-modal-title">ç¼–è¾‘åˆ†ç±»</h3>
            <button class="modal-close" onclick="hideEditModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="edit-form" method="post" action="{% url 'items:manage_categories' %}">
                {% csrf_token %}
                <input type="hidden" name="category_id" id="edit-category-id">
                <input type="hidden" name="old_name" id="edit-old-name">
                
                <div class="form-group">
                    <label for="edit-name" class="form-label">åç§°</label>
                    <input type="text" id="edit-name" name="new_name" class="form-input" placeholder="è¯·è¾“å…¥æ–°åç§°" required>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel-btn" onclick="hideEditModal()">å–æ¶ˆ</button>
            <button class="modal-btn confirm-btn" onclick="document.getElementById('edit-form').submit()">ä¿å­˜</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†
    function showEditModal(type, id, name) {
        const modal = document.getElementById('edit-modal');
        const modalTitle = document.getElementById('edit-modal-title');
        const categoryId = document.getElementById('edit-category-id');
        const oldName = document.getElementById('edit-old-name');
        const editName = document.getElementById('edit-name');
        const form = document.getElementById('edit-form');
        
        // ç§»é™¤ä¹‹å‰å¯èƒ½å­˜åœ¨çš„éšè—å­—æ®µ
        const existingUpdateField = form.querySelector('input[name="update_category"], input[name="update_room"]');
        if (existingUpdateField) {
            existingUpdateField.remove();
        }
        
        // è®¾ç½®æ¨¡æ€æ¡†æ ‡é¢˜å’Œç±»å‹
        if (type === 'category') {
            modalTitle.textContent = 'ç¼–è¾‘åˆ†ç±»';
            categoryId.value = id;
            oldName.value = '';
            // æ·»åŠ åˆ†ç±»æ›´æ–°å­—æ®µ
            const updateField = document.createElement('input');
            updateField.type = 'hidden';
            updateField.name = 'update_category';
            updateField.value = '1';
            form.appendChild(updateField);
        } else {
            modalTitle.textContent = 'ç¼–è¾‘æˆ¿é—´';
            categoryId.value = '';
            oldName.value = name;
            // æ·»åŠ æˆ¿é—´æ›´æ–°å­—æ®µ
            const updateField = document.createElement('input');
            updateField.type = 'hidden';
            updateField.name = 'update_room';
            updateField.value = '1';
            form.appendChild(updateField);
        }
        
        // è®¾ç½®å½“å‰åç§°
        editName.value = name;
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        modal.style.display = 'flex';
        
        // é˜»æ­¢èƒŒæ™¯æ»šåŠ¨
        document.body.style.overflow = 'hidden';
        
        // èšç„¦è¾“å…¥æ¡†
        editName.focus();
    }
    
    // éšè—ç¼–è¾‘æ¨¡æ€æ¡†
    function hideEditModal() {
        const modal = document.getElementById('edit-modal');
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }
    
    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    document.getElementById('edit-modal').addEventListener('click', (e) => {
        if (e.target.id === 'edit-modal') {
            hideEditModal();
        }
    });
    
    // å­æ ‡ç­¾ç‚¹å‡»åˆ‡æ¢åŠŸèƒ½
    document.querySelectorAll('.tag-link').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            
            const tagItem = link.closest('.tag-item');
            const tag = tagItem.dataset.tag;
            
            // æ›´æ–°å­æ ‡ç­¾æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.tag-item').forEach(item => {
                item.classList.remove('active');
            });
            tagItem.classList.add('active');
            
            // åˆ‡æ¢å†…å®¹æ˜¾ç¤º
            if (tag === 'categories') {
                // æ˜¾ç¤ºåˆ†ç±»ç®¡ç†ï¼Œéšè—æˆ¿é—´ç®¡ç†
                document.getElementById('content-categories').style.display = 'block';
                document.getElementById('content-rooms').style.display = 'none';
            } else if (tag === 'rooms') {
                // æ˜¾ç¤ºæˆ¿é—´ç®¡ç†ï¼Œéšè—åˆ†ç±»ç®¡ç†
                document.getElementById('content-categories').style.display = 'none';
                document.getElementById('content-rooms').style.display = 'block';
            }
        });
    });
</script>
{% endblock %}
