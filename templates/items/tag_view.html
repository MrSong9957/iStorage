{% extends 'base_template.html' %}

{% block title %}物品标签 - iStorage{% endblock %}

{% block content %}
<!-- 标签展示区域 -->
<div id="tag-display" class="w-[calc(9rem+20px)] mx-auto glass-card p-2 rounded-xl shadow-lg mb-4 border border-gray-200 bg-white text-center">
    <!-- 隐藏字段，用于存储来源信息 -->
    <input type="hidden" id="source-info" value="{{ source|default:'item_create' }}">
    
    <!-- 物品名称 -->
    <div class="text-2xl font-bold mb-1 max-w-36 mx-auto break-words">{{ name|default:"未命名物品" }}</div>
    
    <!-- 二维码 -->
    <img src="data:image/png;base64,{{ qr_code }}" alt="物品二维码" class="max-w-36 max-h-36 mx-auto">
</div>

<!-- 操作按钮区域 -->
<div class="w-[calc(9rem+20px)] mx-auto space-y-2">
    <button id="print-button" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200">
        打印标签
    </button>
    <button id="input-button" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200">
        保存标签
    </button>
    <button id="back-button" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg transition-colors duration-200">
        返回录入
    </button>
    <p class="text-center text-sm text-blue-500 mt-1">提示：如无需打印，点击保存即可</p>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 打印标签功能
    document.getElementById('print-button').addEventListener('click', function() {
        window.print();
        
        // 打印后直接在当前页面显示成功提示，不刷新页面
        setTimeout(function() {
            // 检查是否已存在成功提示元素
            let alertElement = document.getElementById('print-success-alert');
            
            if (!alertElement) {
                // 创建成功提示元素
                alertElement = document.createElement('div');
                alertElement.id = 'print-success-alert';
                alertElement.className = 'bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-2 text-center animate-fade-in';
                alertElement.innerHTML = '<strong class="font-bold">打印成功！</strong>';
                
                // 插入到标签显示区域上方
                const tagDisplay = document.getElementById('tag-display');
                if (tagDisplay) {
                    tagDisplay.parentNode.insertBefore(alertElement, tagDisplay);
                }
            } else {
                // 如果已存在则显示它
                alertElement.style.display = 'block';
            }
            
            // 3秒后自动隐藏提示
            setTimeout(function() {
                if (alertElement) {
                    alertElement.style.display = 'none';
                }
            }, 3000);
        }, 500);
    });
    
    // 返回录入页面 - 根据来源动态决定
    document.getElementById('back-button').addEventListener('click', function() {
        // 获取来源信息，默认为item_create
        const source = document.getElementById('source-info').value;
        
        // 根据来源决定返回链接
        if (source === 'deposit_storage') {
            window.location.href = '{% url "items:deposit_storage" %}';
        } else {
            window.location.href = '{% url "items:item_create" %}';
        }
    });
    
    // 保存标签按钮
    document.getElementById('input-button').addEventListener('click', function() {
        // 获取标签信息
        const name = '{{ name|escapejs }}';
        const itemCode = '{{ item_code|escapejs }}';
        
        // 显示加载状态
        const button = this;
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = '保存中...';
        
        // 发送AJAX请求保存标签到数据库
        fetch('{% url "items:tag_view" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: new URLSearchParams({
                'action': 'save_tag',
                'name': name,
                'item_code': itemCode,
                'category': '{{ category|default:"item" }}'
            })
        })
        .then(response => {
            return response.json().then(data => {
                if (!response.ok) {
                    throw new Error(data.message || '服务器错误');
                }
                return data;
            });
        })
        .then(data => {
            // 恢复按钮状态
            button.disabled = false;
            button.textContent = originalText;
            
            // 成功时跳转到成功页面
            if (data.success) {
                window.location.href = '{% url "items:success" %}';
            } else {
                // 失败时显示错误信息
                showNotification('bg-red-100 border-red-400 text-red-700', 
                                 `<strong class="font-bold">保存失败！</strong> ${data.message || '未知错误'}`);
            }
        })
        .catch(error => {
            // 恢复按钮状态
            button.disabled = false;
            button.textContent = originalText;
            
            console.error('保存标签时出错:', error);
            // 显示错误提示
            showNotification('bg-red-100 border-red-400 text-red-700', 
                             `<strong class="font-bold">保存失败！</strong> ${error.message || '未知错误，请重试。'}`);
        });
    });
    
    // 显示通知消息的辅助函数
    function showNotification(classes, content) {
        // 检查是否已存在提示元素
        let alertElement = document.getElementById('notification-alert');
        
        if (!alertElement) {
            // 创建提示元素
            alertElement = document.createElement('div');
            alertElement.id = 'notification-alert';
            alertElement.className = 'px-4 py-3 rounded mb-2 text-center transition-opacity duration-300';
            
            // 插入到标签显示区域上方
            const tagDisplay = document.getElementById('tag-display');
            if (tagDisplay) {
                tagDisplay.parentNode.insertBefore(alertElement, tagDisplay);
            }
        }
        
        // 设置样式和内容
        alertElement.className = `${classes} px-4 py-3 rounded mb-2 text-center transition-opacity duration-300 opacity-0`;
        alertElement.innerHTML = content;
        
        // 触发重排后显示（用于动画效果）
        void alertElement.offsetWidth;
        alertElement.style.opacity = '1';
        
        // 3秒后自动隐藏提示
        setTimeout(() => {
            alertElement.style.opacity = '0';
            setTimeout(() => {
                if (alertElement.parentNode) {
                    alertElement.parentNode.removeChild(alertElement);
                }
            }, 300);
        }, 3000);
    }
    
    // 仅打印标签部分
    window.onbeforeprint = function() {
        // 隐藏不需要打印的元素
        const buttons = document.querySelectorAll('button');
        const alert = document.getElementById('print-success-alert');
        const container = document.querySelector('.container');
        const glassCard = document.querySelector('.glass-card');
        const tagDisplay = document.getElementById('tag-display');
        const hintText = document.querySelector('.text-xs.text-blue-500');
        const buttonContainer = document.querySelector('.space-y-2');
        
        // 隐藏所有非标签区域元素
        container.style.maxWidth = '300px';
        glassCard.style.padding = '0';
        glassCard.style.boxShadow = 'none';
        buttonContainer.style.display = 'none';
        
        // 确保标签区域内容居中且左右无间距
        tagDisplay.style.paddingLeft = '0';
        tagDisplay.style.paddingRight = '0';
        
        // 额外保险，确保所有按钮都隐藏
        buttons.forEach(btn => btn.style.display = 'none');
        if (alert) alert.style.display = 'none';
        if (hintText) hintText.style.display = 'none';
    };
    
    window.onafterprint = function() {
        // 恢复隐藏的元素
        const buttons = document.querySelectorAll('button');
        const alert = document.getElementById('print-success-alert');
        const container = document.querySelector('.container');
        const glassCard = document.querySelector('.glass-card');
        const tagDisplay = document.getElementById('tag-display');
        const hintText = document.querySelector('.text-xs.text-blue-500');
        const buttonContainer = document.querySelector('.space-y-2');
        
        // 恢复样式
        container.style.maxWidth = '';
        glassCard.style.padding = '';
        glassCard.style.boxShadow = '';
        buttonContainer.style.display = '';
        
        // 恢复标签区域样式
        tagDisplay.style.paddingLeft = '';
        tagDisplay.style.paddingRight = '';
        
        // 恢复所有按钮
        buttons.forEach(btn => btn.style.display = '');
        if (alert) alert.style.display = '';
        if (hintText) hintText.style.display = '';
    };
</script>
{% endblock %}