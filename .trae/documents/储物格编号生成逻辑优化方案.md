# 储物格编号生成逻辑优化方案

## 一、需求分析

### 核心需求
1. **简化录入**：删除储物格输入框，用户只输入房间和家具
2. **自动编号**：系统自动生成编号，从001开始
3. **独立编号**：每个房间+家具组合独立编号
4. **特定格式**：AA001格式，其中：
   - 第一个字母：房间首字母
   - 第二个字母：家具首字母
   - 3个数字：该房间+家具组合下的顺序编号

## 二、实现方案

### 1. 模型修改
- **修改`Storage`模型的`save()`方法**：实现新的编号生成逻辑
- **保留`unit`字段**：用于存储系统生成的储物格编号
- **新增编号生成逻辑**：
  - 获取房间首字母（大写）
  - 获取家具首字母（大写）
  - 统计该房间+家具组合下的现有数量
  - 生成3位顺序编号（001开始）
  - 组合成AA001格式

### 2. 模板修改
- **删除`deposit_storage.html`中的储物格输入框**
- **简化表单**：只保留房间和家具输入
- **更新JS**：移除储物格相关的验证和处理

### 3. 视图修改
- **更新`deposit_storage`视图**：处理简化后的表单
- **更新`tag_view`视图**：适配新的编号生成逻辑
- **确保数据完整性**：系统自动填充储物格信息

## 三、具体实现步骤

### 1. 修改`Storage`模型
```python
def save(self, *args, **kwargs):
    if not self.pk and not self.storage_code:
        # 获取房间和家具的首字母（大写）
        room_initial = self.room[0].upper() if self.room else 'R'
        furniture_initial = self.furniture[0].upper() if self.furniture else 'F'
        
        # 统计该房间+家具组合下的现有储物格数量
        existing_count = Storage.objects.filter(
            user=self.user,
            room=self.room,
            furniture=self.furniture
        ).count()
        
        # 生成3位顺序编号（从001开始）
        new_number = existing_count + 1
        number_str = f"{new_number:03d}"
        
        # 组合成AA001格式
        self.storage_code = f"{room_initial}{furniture_initial}{number_str}"
        
        # 自动生成unit字段值（使用编号）
        self.unit = f"储物格{number_str}"
    super().save(*args, **kwargs)
```

### 2. 修改`deposit_storage.html`模板
- 删除储物格输入框（第47-52行）
- 更新表单提交逻辑，移除储物格相关验证
- 简化JS处理，只处理房间和家具

### 3. 更新前端JS
```javascript
storageForm.addEventListener('submit', (e) => {
    e.preventDefault();
    
    // 获取表单字段值（只保留房间和家具）
    const room = document.getElementById('id_room').value.trim();
    const furniture = document.getElementById('id_furniture').value.trim();
    
    // 验证字段（只验证房间和家具）
    if (!room || !furniture) {
        alert('请填写所有必填字段');
        return;
    }
    
    // 组合成储物格名称（格式：房间-家具）
    const storageName = `${room}-${furniture}`;
    
    // 设置隐藏字段值
    document.getElementById('hiddenName').value = storageName;
    
    // 更新按钮状态
    const btn = e.target.querySelector('button[type="submit"]');
    btn.innerHTML = '正在生成标签...';
    btn.disabled = true;
    btn.classList.add('opacity-75', 'cursor-not-allowed');
    
    // 手动提交表单
    storageForm.submit();
});
```

### 4. 更新`tag_view`视图
确保视图能正确处理简化后的表单数据，自动生成储物格编号。

## 四、预期效果

1. **简化录入**：用户只需要输入房间和家具，无需输入储物格
2. **自动编号**：系统自动生成AA001格式的编号
3. **独立编号**：每个房间+家具组合从001开始编号
4. **直观易懂**：编号包含房间和家具的首字母，易于识别
5. **减少错误**：减少用户输入错误，提高数据准确性

## 五、测试验证

1. **功能测试**：验证编号生成逻辑是否正确
2. **边界测试**：验证大量数据下的性能
3. **用户体验测试**：验证录入流程是否简化
4. **兼容性测试**：确保与现有功能兼容

通过以上修改，我们可以实现用户要求的储物格编号生成逻辑，简化用户录入流程，提高系统易用性。