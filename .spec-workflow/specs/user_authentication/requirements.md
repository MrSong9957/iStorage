# 用户认证功能需求文档

## 1. 简介

### 1.1 文档目的
本文档详细描述了存储管理系统中的用户认证功能需求，包括多种登录方式、密码管理以及相关安全策略，旨在确保系统访问的安全性和用户体验的便捷性。

### 1.2 术语定义

| 术语 | 解释 |
| :--- | :--- |
| OAuth2 | 开放授权协议，允许用户授权第三方应用访问其在另一服务上的资源 |
| 验证码 | 用于验证用户身份的一次性数字或字符组合 |
| 双因素认证 | 结合两种不同类型的凭证进行身份验证的安全机制 |
| 会话管理 | 维护用户登录状态的机制 |

## 2. 功能需求（Functional Requirements）

| 需求ID | 功能点 | 用户故事/缘由说明 | 输入/输出/流程 | 详细说明 | 验收标准 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| FR-001 | 邮箱/密码登录 | 作为用户，我希望通过邮箱和密码登录系统，以便访问我的储物信息 | 输入：邮箱/手机号、密码<br>输出：登录成功页/错误提示<br>流程：输入凭证→验证→成功跳转/失败提示 | 1. 支持邮箱地址作为登录凭证<br>2. 支持手机号作为登录凭证（自动识别）<br>3. 密码输入框支持显示/隐藏切换<br>4. 提供记住登录状态选项<br>5. 登录失败时显示明确错误信息<br>6. 连续失败5次后锁定账户15分钟 | 1. 有效邮箱+正确密码可成功登录<br>2. 有效手机号+正确密码可成功登录<br>3. 错误凭证显示相应错误提示<br>4. 记住登录状态功能正常 |
| FR-002 | 微信第三方登录 | 作为用户，我希望使用微信账号快速登录系统，以便无需记忆额外的账户密码 | 输入：微信扫码/授权<br>输出：登录成功页/错误提示<br>流程：点击微信登录→跳转授权→回调→成功登录 | 1. 提供微信登录按钮<br>2. 跳转到微信授权页面<br>3. 授权成功后回调并登录<br>4. 首次登录时进行账号绑定或创建新账号 | 1. 微信登录按钮正常显示<br>2. 授权流程完整无误<br>3. 授权成功后可正常登录<br>4. 首次使用时正确处理账号关联 |
| FR-003 | QQ第三方登录 | 作为用户，我希望使用QQ账号快速登录系统，以便无需记忆额外的账户密码 | 输入：QQ扫码/授权<br>输出：登录成功页/错误提示<br>流程：点击QQ登录→跳转授权→回调→成功登录 | 1. 提供QQ登录按钮<br>2. 跳转到QQ授权页面<br>3. 授权成功后回调并登录<br>4. 首次登录时进行账号绑定或创建新账号 | 1. QQ登录按钮正常显示<br>2. 授权流程完整无误<br>3. 授权成功后可正常登录<br>4. 首次使用时正确处理账号关联 |
| FR-004 | 支付宝第三方登录 | 作为用户，我希望使用支付宝账号快速登录系统，以便无需记忆额外的账户密码 | 输入：支付宝扫码/授权<br>输出：登录成功页/错误提示<br>流程：点击支付宝登录→跳转授权→回调→成功登录 | 1. 提供支付宝登录按钮<br>2. 跳转到支付宝授权页面<br>3. 授权成功后回调并登录<br>4. 首次登录时进行账号绑定或创建新账号 | 1. 支付宝登录按钮正常显示<br>2. 授权流程完整无误<br>3. 授权成功后可正常登录<br>4. 首次使用时正确处理账号关联 |
| FR-005 | 手机号验证码找回密码 | 作为用户，我希望通过手机验证码重置我的密码，以便在忘记密码时能快速恢复账户访问 | 输入：手机号、验证码、新密码<br>输出：重置成功提示/错误信息<br>流程：输入手机号→获取验证码→输入验证码→设置新密码→重置成功 | 1. 提供手机号找回密码入口<br>2. 手机号格式验证<br>3. 发送6位数字验证码<br>4. 验证码有效期5分钟<br>5. 支持重新发送（间隔60秒）<br>6. 新密码强度验证<br>7. 成功后自动登录并提示用户 | 1. 有效手机号可接收验证码<br>2. 验证码正确验证<br>3. 密码重置成功<br>4. 重置后可使用新密码登录 |
| FR-006 | 邮箱链接找回密码 | 作为用户，我希望通过邮箱链接重置我的密码，以便在忘记密码时能安全地恢复账户访问 | 输入：邮箱地址<br>输出：邮件发送成功提示/错误信息<br>流程：输入邮箱→发送重置链接→用户点击链接→设置新密码→重置成功 | 1. 提供邮箱找回密码入口<br>2. 邮箱格式验证<br>3. 发送包含重置链接的邮件<br>4. 链接有效期24小时<br>5. 链接使用一次后失效<br>6. 新密码强度验证<br>7. 成功后自动登录并提示用户 | 1. 有效邮箱可收到重置邮件<br>2. 点击链接可访问重置页面<br>3. 密码重置成功<br>4. 重置后可使用新密码登录 |
| FR-007 | 用户注册 | 作为新用户，我希望能注册一个新账号，以便使用系统的储物管理功能 | 输入：邮箱/手机号、密码、确认密码<br>输出：注册成功页/错误提示<br>流程：输入注册信息→验证→注册成功→自动登录 | 1. 支持邮箱注册<br>2. 支持手机号注册<br>3. 密码强度验证<br>4. 邮箱/手机号唯一性检查<br>5. 注册成功后自动登录 | 1. 有效信息可成功注册<br>2. 重复账号提示错误<br>3. 弱密码提示错误<br>4. 注册后自动登录系统 |
| FR-008 | 账号绑定管理 | 作为用户，我希望管理我的账号绑定关系，以便灵活使用多种登录方式 | 输入：绑定/解绑操作<br>输出：操作结果提示<br>流程：进入账户设置→管理绑定→执行操作→结果反馈 | 1. 在用户设置中提供绑定管理入口<br>2. 显示已绑定和未绑定的第三方账号<br>3. 支持绑定新的第三方账号<br>4. 支持解绑已绑定的第三方账号（保留至少一种登录方式） | 1. 可成功绑定新的第三方账号<br>2. 可成功解绑已绑定账号<br>3. 至少保留一种登录方式<br>4. 绑定状态正确显示 |
| FR-009 | 安全设置 | 作为用户，我希望能配置账户安全选项，以便提高我的账户安全性 | 输入：设置选项<br>输出：设置保存结果<br>流程：进入安全设置→配置选项→保存设置 | 1. 提供修改密码功能<br>2. 提供双因素认证设置（可选）<br>3. 显示登录历史记录<br>4. 提供登录设备管理 | 1. 密码修改功能正常<br>2. 安全设置正确保存<br>3. 登录历史准确记录 |

## 3. 非功能需求（Non-Functional Requirements）

| 需求ID | 需求点 | 详细说明 | 验收标准 |
| :--- | :--- | :--- | :--- |
| NF-001 | 安全性 | 1. 所有密码使用bcrypt或Argon2等安全哈希算法存储<br>2. 密码传输使用HTTPS加密<br>3. 防止暴力破解攻击（登录失败次数限制）<br>4. 防止CSRF攻击<br>5. 敏感数据脱敏显示 | 1. 密码哈希存储验证<br>2. 网络传输抓包验证<br>3. 暴力破解测试<br>4. CSRF测试通过 |
| NF-002 | 可用性 | 1. 登录页面加载时间<2秒<br>2. 认证操作响应时间<1秒<br>3. 第三方登录重定向流畅<br>4. 移动端适配良好 | 1. 性能测试符合要求<br>2. 多设备兼容性测试通过 |
| NF-003 | 兼容性 | 1. 支持主流浏览器：Chrome、Firefox、Safari、Edge<br>2. 支持移动设备浏览器<br>3. 第三方登录支持最新的OAuth2标准 | 1. 跨浏览器测试通过<br>2. 移动端测试通过 |
| NF-004 | 可扩展性 | 1. 认证系统设计支持未来添加其他认证方式<br>2. 用户数据模型可扩展<br>3. 支持水平扩展 | 1. 架构评审通过<br>2. 添加新认证方式测试 |
| NF-005 | 可维护性 | 1. 代码遵循Django最佳实践<br>2. 提供完整的日志记录<br>3. 错误处理机制完善 | 1. 代码审查通过<br>2. 日志记录完整<br>3. 错误处理测试 |

## 4. 数据需求

| 需求ID | 数据点 | 数据结构 | 存储方式 | 验收标准 |
| :--- | :--- | :--- | :--- | :--- |
| DR-001 | 用户基本信息 | 包含用户ID、邮箱、手机号、密码哈希、创建时间、最后登录时间等字段 | 关系型数据库 | 1. 数据模型正确定义<br>2. 数据完整性约束正确 |
| DR-002 | 第三方账号关联 | 包含用户ID、第三方平台类型、第三方用户ID、访问令牌、刷新令牌等字段 | 关系型数据库 | 1. 关联表正确定义<br>2. 外键约束正确 |
| DR-003 | 验证码信息 | 包含目标（手机/邮箱）、验证码、创建时间、过期时间、使用状态等字段 | 关系型数据库/缓存 | 1. 验证码正确生成和存储<br>2. 过期机制正常工作 |
| DR-004 | 密码重置令牌 | 包含用户ID、重置令牌、创建时间、过期时间、使用状态等字段 | 关系型数据库 | 1. 令牌正确生成和存储<br>2. 过期和使用机制正常 |
| DR-005 | 登录历史 | 包含用户ID、登录时间、IP地址、设备信息、登录结果等字段 | 关系型数据库 | 1. 登录记录完整<br>2. 数据查询性能符合要求 |

## 5. 范围限定

| 边界/范围限定 | 说明 |
| :--- | :--- |
| 仅支持指定第三方平台 | 本需求仅包含微信、QQ、支付宝三个第三方平台的OAuth2登录 |
| 不包含短信服务商集成 | 手机号验证码功能需要集成外部短信服务商，但具体集成实现不在本需求范围内 |
| 不包含复杂的权限管理 | 本需求专注于认证功能，不包含细粒度的权限控制系统 |
| 邮箱服务配置 | 系统需要配置SMTP服务，但具体配置不在本需求范围内 |

## 6. 验收标准（Acceptance Criteria）

1. 所有功能需求点都能正常工作，符合详细说明中的要求
2. 安全性测试通过，包括密码存储、传输加密、防止攻击等
3. 性能符合非功能需求中的要求
4. 所有认证方式在不同设备和浏览器上都能正常工作
5. 错误处理完善，用户能收到清晰的错误提示
6. 代码符合Django最佳实践和项目编码规范

## 7. 风险/依赖备注区

| 类型     | 关联编号/功能点 | 具体内容/说明                          | 备注      |
| :----- | :------- | :------------------------------- | :------ |
| 依赖项    | FR-002/FR-003/FR-004 | 需要申请并配置微信、QQ、支付宝的开发者账号和OAuth应用 | 需提前申请，获取AppID和AppSecret |
| 依赖项    | FR-005 | 手机号验证码功能依赖短信服务提供商 | 建议评估并选择合适的短信服务商 |
| 依赖项    | FR-006 | 邮箱密码重置功能依赖SMTP服务配置 | 需配置可用的邮箱服务器信息 |
| 风险点    | FR-002/FR-003/FR-004 | 第三方平台API变更可能导致功能失效 | 建议实现监控机制，及时发现API变化 |
| 风险点    | FR-005 | 短信发送可能存在延迟或失败情况 | 实现重试机制和状态提示 |
| 风险点    | NF-001 | 安全威胁不断演变，需要持续更新安全策略 | 定期进行安全审计和更新 |